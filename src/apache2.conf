# Give a default, otherwise it will inherit from hostname, which is
# comicslate.org, thus hiding our VirtualHost entry for HTTP below!
ServerName localhost

<Macro SSL $host>
	# Do not try to enable SSL without certificates.
	<IfDefine !NoSSL>
		SSLEngine on
		SSLCertificateFile /etc/letsencrypt/live/$host/cert.pem
		SSLCertificateKeyFile /etc/letsencrypt/live/$host/privkey.pem
		SSLCertificateChainFile /etc/letsencrypt/live/$host/chain.pem

		# https://googlechrome.github.io/samples/csp-upgrade-insecure-requests/
		# If there are insecure (http://) links on the page, they will automatically
		# be replaced with https, without showing the "mixed content" warning.
		#2016-04-06: DISABLED: there are unfortunately http-only links on the pages.
		#Header set "Content-Security-Policy" "upgrade-insecure-requests"

		# https://www.chromium.org/hsts
		# Remember that this site was contacted by https, and show an error message
		# for downgrade (to http) attacks. 3Ms ~= 34 days
		Header set "Strict-Transport-Security" "max-age=3000000"

		Header set "X-XSS-Protection" "1; mode=block"
		Header set "X-Frame-Options" "SAMEORIGIN"
	</IfDefine>
</Macro>

<Macro UpgradeToSSL>
	# Do not try to enable SSL without certificates.
	<IfDefine !NoSSL>
		# https://www.w3.org/TR/upgrade-insecure-requests/#preference
		# Redirect browser to HTTPS if it claims support.
		RewriteEngine on
		RewriteCond "%{HTTP:Upgrade-Insecure-Requests}" "^(1|yes)$" [nocase]
		RewriteCond "%{HTTP:User-Agent}" "!Windows NT 5" [nocase]
		RewriteRule ".*" https://%{HTTP_HOST}%{REQUEST_URI} [redirect]
	</IfDefine>
</Macro>

<Macro Log $host>
	ErrorLog /var/www/.htsecure/log/$host.error.log
	# Possible values include: debug, info, notice, warn, error, crit,
	# alert, emerg.
	LogLevel warn
	# Add 'rewrite:trace3' to the line above for RewriteEngine debug.
	CustomLog /var/www/.htsecure/log/$host.access.log combined
	CustomLog /var/www/.htsecure/log/$host.full.log \
		"[%{%F %T}t.%{usec_frac}t %{%z}t]\n\
    Client: %{CF-Connecting-IP}i (%{CF-IPCountry}i) via CloudFlare %a:%{remote}p\n\
    Request: %{X-Forwarded-Proto}i://%{Host}i %r\n\
    User-Agent: %{User-Agent}i\n\
    Referer: %{Referer}i\n\
    Server: [%A:%{local}p] %v: %R:%f\n\
    Response: HTTP %s %301,302{Location}o, %B bytes of %{Content-Type}o in %D usec"
</Macro>

<Macro VHost $host>
	# ftype is required to put these "filters" before GZIP in the filter chain
	ExtFilterDefine april1html mode=output intype=text/html \
		cmd="/opt/bin/nobody/april1.py"
	ExtFilterDefine april1png mode=output intype=image/png \
		cmd="/bin/bash -c '[ $RANDOM -gt 25000 ] && /usr/bin/convert - -flip - || cat'" \
		ftype=19
	ExtFilterDefine april1jpg mode=output intype=image/jpg \
		cmd="/bin/bash -c '[ $RANDOM -gt 25000 ] && /usr/bin/convert - -flip - || cat'" \
		ftype=19
	ExtFilterDefine april1jpeg mode=output intype=image/jpeg \
		cmd="/bin/bash -c '[ $RANDOM -gt 25000 ] && /usr/bin/convert - -flip - || cat'" \
		ftype=19

	ServerName $host
	ServerAlias www.$host localhost
	DocumentRoot /var/www/$host
	<Directory /var/www/$host>
		#SetOutputFilter april1html;april1png;april1jpg;april1jpeg

		Options FollowSymLinks MultiViews
		AllowOverride All

		Require ip 127.0.0.0/24
		Require ip ::1

		Include conf-available/cloudflare_ip.part
		Include conf-available/hetzner_ip.part
	</Directory>

	Use Log $host
</Macro>

<VirtualHost *:80>
	Use VHost comicslate.org
	Use UpgradeToSSL
</VirtualHost>
<VirtualHost *:443>
	Use VHost comicslate.org
	Use SSL comicslate.org
</VirtualHost>

<VirtualHost *:80>
	Use VHost test.comicslate.org
	Use UpgradeToSSL
</VirtualHost>
<VirtualHost *:443>
	Use VHost test.comicslate.org
	Use SSL test.comicslate.org
</VirtualHost>

# vim: ft=apache
